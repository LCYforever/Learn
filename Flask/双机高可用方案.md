# 概念介绍

### 双机热备
双机热备特指高可用服务器集群中两台服务器的高可用。本文的目标是实现如下场景：

- 两台 Web 服务器为主从备份，并同时开启，但只有主服务器对外提供服务。（或者通过负载均衡同时对外提供服务）
- 当主服务器宕机时，从服务器接管服务，且 IP 地址保持不变。
- 主服务器与从服务器的数据库与静态文件资源保持实时一致。

### LVS
LVS（Linux Virtual Server）即 Linux 虚拟服务器，采用 IP 负载均衡技术和基于内容请求分发技术，是一个高可伸缩、高可用网络服务的虚拟服务器集群系统，主要用于服务器集群的负载均衡。

使用 LVS 架设的服务器集群系统有三个部分组成：

- **负载调度器**（Load Balancer）：整个集群对外服务的前端机，负责将用户请求发送到一组服务器上执行，而用户认为服务只来自一个IP地址（即 Virtual IP）。
- **服务器集群**（Server Array），是一组真正执行客户请求的服务器（Real Server），执行的服务包括但不限于 WEB、MAIL、FTP 和 DNS 等。
- **共享存储**（Shared Storage）：为服务器池所提供的一个共享存储区，这样可使得服务器集群拥有相同的内容，提供相同的服务。

> LVS 集群中的负载调度器具有很好的吞吐率，可将请求均衡地转移到不同的服务器上执行，且负载调度器自动屏蔽掉服务器的故障，从而将一组服务器构成一个高性能的、高可用的虚拟服务器。整个服务器集群的结构对客户是黑箱状态，而且无需修改客户端和服务器端的程序。

![enter image description here](http://img1.51cto.com/attachment/201104/110349553.png)

LVS 的实现方式分为 NAT（网络地址转换）与 DR（直接路由）两种。

- NAT：目标 IP 为 VIP 的用户请求经过 DS （Director Server）时进行了 IP 地址转换，把 VIP 换成了 RS 的 IP，RS 处理完请求后需要把 response 再发回给 DS，再由 DS 转换 IP 后发给请求的用户。优点是服务器可以运行任何支持 TCP/IP 的操作系统；缺点是 response 都要经过 DS，伸缩能力有限，难以支持大集群。
- DR：目标 IP 为 VIP 的用户请求经过 DS （Director Server）时进行了 MAC 地址转换，把 MAC 地址修改为了 RS 的 MAC 地址，RS 处理完请求后把 response 直接返回给用户。优点是伸缩性强，但需要 DS 与 RS 在同一个子网。

> 注意：LVS 集群中的负载调度器不可与真实服务器是同一台机器，因为 LVS 是**四层负载均衡**（基于传输层，请求的转发通过修改 IP 地址或目标 MAC 地址来实现），所以无法保证一个请求是交付给本机的负载均衡器进行调度还是交付给本机的应用程序处理，因此可能会陷入自己不断把请求发给自己的死循环。

[LVS 官方中文文档](http://www.linuxvirtualserver.org/zh/lvs1.html)

### Keepalived
Keepalived 是一款高可用软件，它的功能主要包括两方面：

- 基于 VRRP 协议，通过 IP 漂移实现服务的高可用：服务器集群共享一个虚拟 IP，同一时间只有一个服务器占有虚拟 IP 并对外提供服务。若该服务器不可用，则虚拟 IP 漂移至另一台服务器并对外提供服务；
- 对 LVS 应用服务层的应用服务器集群进行状态监控：若应用服务器不可用，则 Keepalived 将其从集群中摘除，若应用服务器恢复，则 Keepalived 将其重新加入集群中。

> Keepalived 可以单独使用，即通过 IP 漂移实现服务的高可用，也可以结合 LVS 使用（即一方面通过IP漂移实现 LVS 负载均衡层的高可用，另一方面实现 LVS 应用服务层的状态监控）。

### Heartbeat
Heartbeat 是 Linux-HA 工程的一个组件，是集群管理中保证集群高可用的服务软件，它可以瞬间接管一台机器上的所有资源（包括访问资源、提供服务的资源和IP地址等等）。

Heartbeat 最核心的两个部分是**心跳监测**和**资源接管**。**心跳监测**使设备之间相互发送报文来告诉对方自己当前的状态，如果在指定的时间内未收到对方发送的报文，那么就认为对方失效，这时需启动**资源接管**模块来接管运行在对方主机上的资源或者服务。

### Keepalived VS Heartbeat
- Keepalived 使用更简单：从安装、配置、使用、维护等角度上对比，Keepalived 都比 Heartbeat 要简单得多，尤其是 Heartbeat 2.1.4 后拆分成3个子项目，安装、配置、使用都比较复杂；而 Keepalived 只有1个安装文件和1个配置文件。
- Heartbeat 功能更强大：Heartbeat 虽然复杂，但功能更强大，配套工具更全，适合做大型集群管理；而 Keepalived 主要用于集群倒换，基本没有管理功能。
- 协议不同：Keepalived 使用 VRRP 协议进行通信和选举，Heartbeat 使用心跳进行通信和选举；Heartbeat 除了网络外还可以通过串口通信，更加可靠。
- 使用方式类似：如果要基于两者设计高可用方案，最终都要根据业务需要写自定义的脚本。Keepalived 的脚本没有约束；Heartbeat 的脚本有约束，即需要支持 service start/stop/restart 这种方式。
- 接管方式不同：Keepalived 仅能用于接管IP地址，而 Heartbeat 可以接管IP、服务、存储等多种资源。且 Keepalived 集群中所有节点保证服务都开启，而 Heartbeat 集群只需要保证主节点服务开启即可（主节点宕机再由从节点开启服务）。

> 建议：优先使用 Keepalived，当 Keepalived 功能不够用的时候才选择 Heartbeat

[What is the difference between keepalive and heartbeat?](https://serverfault.com/questions/361071/what-is-the-difference-between-keepalive-and-heartbeat)

### DRBD
DRBD （Distributed Replicated Block Device）是一种基于软件的，无共享，复制的存储解决方案，在服务器之间对块设备（硬盘，分区，逻辑卷等）进行镜像。DRBD 负责接收数据，把数据写到本地磁盘，然后通过网络将同样的数据发送给另一个主机，另一个主机再将数据存到自己的磁盘中。

工作原理：每个设备都有一个状态，可能是**主状态**或**从状态**。在主节点上，应用程序应能运行和访问 DRBD 设备（/dev/drbd*），且每次写入都会发往本地磁盘设备和从节点设备中。从节点只能简单地把数据写入它的磁盘设备上。 读取数据通常在本地进行。 如果主节点发生故障，心跳（heartbeat 或 corosync）将会把从节点转换到主状态，并启动其上的应用程序。如果发生故障的节点恢复工作，它就会成为新的从节点，而且必须使自己的内容与主节点的内容保持同步。





# LVS + keepalived 部署方案（CentOS）

### 前期准备
准备四台虚机，分别记作 LVS-master、LVS-slave、web-node1、web-node2。前两者作为 LVS 负载均衡调度器，后两者是提供应用服务的 web 服务器。

安装`epel-realease`源，关闭所有虚机的防火墙与 SELinux，编辑所有节点的`/etc/hosts`文件设置主机名互相解析。使用`yum install ntpdate`安装 ntpdate，并通过`ntpdate 202.120.2.101`命令进行时间同步。

> 202.120.2.101 是上海交通大学网络中心 NTP 服务器的地址


### web 节点配置
在两台 web 机上开启 httpd 服务，并编辑 Real Server （真实服务器，简称 RS）的 绑定 VIP （虚拟 IP）脚本`realserver.sh`如下：

```
#!/bin/bash  
#   
# Script to start LVS DR real server.   
# description: LVS DR real server   
#   
.  /etc/rc.d/init.d/functions
VIP=192.168.18.200   # 在此处设置VIP  
host=`/bin/hostname`
case "$1" in  
start)   
       # Start LVS-DR real server on this machine.   
        /sbin/ifconfig lo down   
        /sbin/ifconfig lo up   
        echo 1 > /proc/sys/net/ipv4/conf/lo/arp_ignore   
        echo 2 > /proc/sys/net/ipv4/conf/lo/arp_announce   
        echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore   
        echo 2 > /proc/sys/net/ipv4/conf/all/arp_announce
        /sbin/ifconfig lo:0 $VIP broadcast $VIP netmask 255.255.255.255 up  
        /sbin/route add -host $VIP dev lo:0
;;  
stop)
        # Stop LVS-DR real server loopback device(s).  
        /sbin/ifconfig lo:0 down   
        echo 0 > /proc/sys/net/ipv4/conf/lo/arp_ignore   
        echo 0 > /proc/sys/net/ipv4/conf/lo/arp_announce   
        echo 0 > /proc/sys/net/ipv4/conf/all/arp_ignore   
        echo 0 > /proc/sys/net/ipv4/conf/all/arp_announce
;;  
status)
        # Status of LVS-DR real server.  
        islothere=`/sbin/ifconfig lo:0 | grep $VIP`   
        isrothere=`netstat -rn | grep "lo:0" | grep $VIP`   
        if [ ! "$islothere" -o ! "isrothere" ];then   
            # Either the route or the lo:0 device   
            # not found.   
            echo "LVS-DR real server Stopped."   
        else   
            echo "LVS-DR real server Running."   
        fi   
;;   
*)   
            # Invalid entry.   
            echo "$0: Usage: $0 {start|status|stop}"   
            exit 1   
;;   
esac   
```
使用 `chmod +x realserver.sh`命令给脚本文件添加执行权限，并通过`/.realserver.sh start`命令启动该脚本的服务。该服务的作用是使 RS 的网卡与 VIP 进行绑定，从而允许 RS 可处理来自负载调度器转发的请求（DR 模式）。启动该服务后可用`ifconfig`命令查看是否已绑定 VIP。

### LVS 节点配置
LVS 节点使用`yum install keepalived ipvsadm`命令安装 keepalived 服务与 LVS 服务。

配置文件的路径是`/etc/keepalived/keepalived.conf`。keepalived 配置文件以 block 形式组织，每个块内容都包含在`{}`中。keepalived 配置分为三类：

- 全局配置：对整个 keepalived 都生效的配置
- VRRPD 配置：核心配置，主要实现高可用功能
- LVS 配置：LVS 相关功能的配置

```
######################
#  全局配置（大部分选项为邮件通知服务的参数。可设置为空）
######################
global_defs {                               # global_defs 全局配置标识 
                                            --------------------------------------
   notification_email {                     # notification_email用于设置报警邮件地址
     acassen@firewall.loc                   # 可以设置多个，每行一个
     failover@firewall.loc                  # 设置邮件报警，需开启本机Sendmail 服务
     sysadmin@firewall.loc                  # yum -y install mailx sendmail
   }                                        --------------------------------------
   
   notification_email_from Alexandre.Cassen@firewall.loc  # 设置邮件发送地址
   smtp_server 192.168.200.1                              # 设置邮件的smtp server地址
   smtp_connect_timeout 30                                # 设置连接smtp sever超时时间
   router_id LVS_DEVEL                                    # 表示运行keepalived服务器标识，发邮件时显示在邮件主题中的信息
}

######################
#  VRRPD配置
######################

vrrp_instance VI_1 {         # VRRPD 配置标识 VI_1是实例名称

    state MASTER             # 指定Keepalvied角色 MASTER表示此主机为主服务器 BACKUP则是表示为备用服务器
    interface eth0           # 指定HA监测网络的接口。检查是否与ifconfig命令查看的网卡名称一致。
    virtual_router_id 51     # 虚拟路由标识，标识为数字，同一个VRRP实例使用唯一的标识
                             # 即可表示在同一个vrrp_instance下 MASTER_ID = BACKUP_ID
    priority 100             # 定义节点优先级，数字越大表示节点的优先级越高
                             # 同一个VRRP_instance下
                             # 必须 MASTE_PRIORITY > BACKUP_PRIORITY 
    advert_int 1             # 设定MASTER与BACKUP主机质检同步检查的时间间隔，单位为秒
             
    authentication {         # 设定节点间通信验证类型和密码，验证类型主要有PASS和AH两种
        auth_type PASS       # 同一个vrrp_instance，MASTER验证密码和BACKUP保持一致
        auth_pass 1111
    }
    
    virtual_ipaddress {      # 设置虚拟IP地址 (VIP)，也可仅设置一个
        192.168.200.16
        192.168.200.17
        192.168.200.18
    }
}

######################
# LVS配置
######################

virtual_server 192.168.18.200 80 {    # virtual_server LVS配置标识 
                                      # 格式：virtual_server [VIP] [port]
    delay_loop 6     # 设置健康检查时间间隔，单位为秒   
    lb_algo rr       # 设置负载调度算法，可用的调度算法有：rr、wlc、lc、lblc、sh、dh等
    lb_kind DR       # 设置LVS实现负载均衡的机制，有NAT、TUN和DR三种模式可选                   
    nat_mask 255.255.255.0   # NAT子网掩码
    persistence_timeout 50  # 会话保持时间 
    protocol TCP             # 指定转发协议类型
    
#---------------------------------------------------------------------------------
# persistence_timeout 会话保持时间对动态网页非常有用，为集群系统中的seesion共享提供了一个很好的解决方案
# 用户的请求会一直分发到某个服务节点，直至超过这个会话的保持时间（指最大无响应超时时间）
# =[用户操作动态页面如果在50s没有执行任何操作则被分发到另外的节点]
#---------------------------------------------------------------------------------

    real_server 192.168.18.201 80 { # 设置real server段开始的标识 [IP为真实IP地址]
        weight 1                    # 用于配置real server节点的权值，数字越大，权值越高
                                    # 设置权值大小可以为不同性能的服务器分配不同的负载
        HTTP_GET {   
            url {   
              path /   
          status_code 200   
            }   
            connect_timeout 2   
            nb_get_retry 3   
            delay_before_retry 1   
        }   
    }   
    real_server 192.168.18.202 80 {   
        weight 1   
        HTTP_GET {   
            url {   
              path /   
              status_code 200   
            }   
            connect_timeout 2   
            nb_get_retry 3   
            delay_before_retry 1   
        }   
    }   
}
```

keepalived 的配置文件路径在`/etc/keepalived/keepalived.conf`。LVS-master 与 LVS-slave 的配置文件除了 VRRPD 配置中的状态与优先级不同外，其他参数应当相同。

配置完成后，启动 LVS-master 与 LVS-slave的 keepalived 服务：`service keepalived start`，并可使用`ipvsadm -L -n`命令查看 LVS 状态。

> Tips：可使用`service keepalived status`命令查看 keepalived 服务的 log。

### 测试

通过关闭与开启 LVS-master 的 keepalived 服务，观察 VIP 的浮动情况。通过关闭与开启某一个 web 节点的 web 服务，观察负载均衡的调度结果。

### 参考文档
实验步骤参考：[Linux 高可用集群之keepalived详解](http://freeloda.blog.51cto.com/2033581/1280962)
详细配置参数参考：[Keepalived 工作原理及简要安装](https://my.oschina.net/luciamoore/blog/607034)










# Heartbeat 部署方案（CentOS）

> 注意：Heartbeat 方案本人还未有实践过

## 安装
两种安装方式：

- 主从节点都使用`yum install heartbeat*`命令安装 Heartbeat（须确保已安装 epel 扩展软件包源）。
- 在 Linux-HA 官网下载 [Heartbeat](http://www.linux-ha.org/wiki/Downloads)。

## 配置

Heartbeat 主要的配置文件有 3 个，分别是 **authkeys**，**ha.cf** 和 **haresources**。其中 ha.cf 是主配置文件，haresource 用来配置要让 Heartbeat 托管的服务，authkey 是用来指定 Heartbeat 的认证方式。

> 在 Heartbeat 安装后，默认并没有这三个文件，可以直接从解压的源码目录中找到。

这里以 master/slave 两节点为例，示例的配置文件为 master 节点的。

### 认证文件（/etc/ha.d/authkeys）
该文件为 Heartbeat 的认证文件，该文件主要是用于集群中两个节点的认证，采用的算法和密钥（如果有的话）在集群中节点上必须相同。目前提供了 3 种算法：crc/md5/sha1。其中 crc 不能够提供认证，它只能够用于校验数据包是否损坏，而 sha1/md5 需要一个密钥来进行认证。

```
auth 2
#1 crc
2 sha1 somewords
#3 md5 somewords
```

以上示例中使用的是 sha1 算法，如果要换用其他算法只需要修改 auth 指令后面的数字，然后取消相应行的注释即可。

> 注意：该文件的属性必须为600，否则 Heartbeat 启动将失败。且两个节点的 authkeys 文件内容及权限相同。

### 主配置文件（/etc/ha.d/ha.cf）

该文件是 Heartbeat 的主配置文件。

```
keepalive 2
warntime 5
deadtime 30
initdead 120
udpport 6942
bcast eth0
# mcast eth0 225.0.0.1 694 1 0
ucast eth1 {{ slave的IP地址 }}
auto_failback off
watchdog /dev/watchdog
node host41 host42
# ping 172.16.12.1 ping_group group1 172.16.12.1
respawn hacluster /usr/lib64/heartbeat/ipfail
respawn hacluster /usr/lib64/heartbeat/dopd
apiauth dopd gid=haclient uid=hacluster
use_logd yes
```

- keepalive：发送心跳报文的间隔。默认单位为秒，也可以使用 500ms 来指代 500 毫秒，等同于 0.5。
- warntime：认为对方可能宕掉的间隔时间。
- deadtime：认为对方宕掉的间隔时间，超过这个时间，则认为对方已经宕掉。
- initdead：等待对方启动的最大时间。
- udpport：heartbeat 广播/单播通讯使用的 udp 端口。
- bcast：心跳所使用的网络接口。
- ucast：单播通讯，对方网络接口及IP地址。
- mcast：组播通讯，参数如右：通讯所用的接口 绑定的组播IP（224.0.0.0-239.255.255.255）通讯端口 ttl 是否允许环回。
- auto_failback：表示当主节点（即提供资源/服务的节点）正常之后是否将资源/服务切换回来。
- watchdog：看门狗定时器，如果节点一分钟内没有心跳，则重启节点。
- node：heartbeat 集群中的节点信息（节点的主机名: uname -n）。
- ping/ping_group：用于建立伪集群成员，作用是监测物理链路，如果该节点与伪集群成员不相通，那么该节点无权接管资源/服务。

另一从节点（slave）需要将 ha.cf 文件中 ucast 的 IP 地址改为主节点（master）的 IP 地址。

### 资源文件（/etc/ha.d/haresources）
haresources 文件用于指定双机系统的主节点、集群IP、子网掩码、广播地址以及启动的服务等集群资源。文件每一行可以包含一个或多个资源脚本名，资源之间使用空格隔开，参数之间使用两个冒号隔开。在两个节点上该文件必须完全一致，此文件的一般格式为：
```
node-name network <resource-group>
```
node-name 表示主节点的主机名，必须和 ha.cf 文件中指定的节点名一致；network 用于设定集群的 IP 地址、子网掩码、网络设备标识等（这里指定的IP地址就是集群对外服务的IP地址），resource-group 用来指定需要 Heartbeat 托管的服务，也就是这些服务可以由 Heartbeat 来启动和关闭，如果要托管这些服务，必须将服务写成可以通过 start/stop 来启动和关闭的脚本，然后放到 /etc/init.d/ 或者 /etc/ha.d/resource.d/ 目录下，heartbeat 会根据脚本的名称自动去 /etc/init.d 或者 /etc/ha.d/resource.d/ 目录下找到相应脚本进行启动或关闭操作。

以下是一个具体实例：
```
node1 IPaddr::192.168.60.200/24/eth0/  Filesystem::/dev/sdb5::/webdata::ext3  httpd tomcat
```
其中，node1 是 HA 集群的主节点，IPaddr 为 HeartbeatH自带的一个执行脚本，Heartbeat 首先将执行`/etc/ha.d/resource.d/IPaddr 192.168.60.200/24 start`的操作，也就是虚拟出一个子网掩码为 255.255.255.0，IP为 192.168.60.200 的地址，此IP为 Heartbeat 对外提供服务的网络地址，同时指定此 IP 使用的网络接口为 eth0，接着，Heartbeat 将执行共享磁盘分区的挂载操作，`Filesystem::/dev/sdb5::/webdata::ext3`相当于在命令行下执行 mount 操作，即“mount –t ext3 /dev/sdb5 /webdata”，最后依次启动 httpd 和 tomcat 服务。

> 注意：主节点和从节点中资源文件 haresources 一般要完全一致。

### 参考文档

[Linux-HA开源软件Heartbeat（配置篇）](http://ixdba.blog.51cto.com/2895551/548625)
[heartbeat配置相关](https://github.com/chenzhiwei/linux/tree/master/heartbeat)