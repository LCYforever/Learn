# 概念介绍

### 双机热备
双机热备特指基于高可用系统中的两台服务器的高可用。双机高可用按工作中的切换方式分为主-备方式（Active-Standby 方式）和双主机方式（Active-Active 方式）。

- 主-备方式：一台服务器处于某种业务的激活状态（即 Active 状态），另一台服务器处于该业务的备用状态（即 Standby 状态)。
- 双主机方式：两种不同业务分别在两台服务器上互为主备状态（即 Active-Standby 和 Standby-Active 状态）。

### Heartbeat
Heartbeat 是 Linux-HA 工程的一个组件，是集群管理中保证集群高可用的一个服务软件，它可以瞬间接管一台机器上的所有资源（包括访问资源、提供服务的资源和IP地址等等）。

Heartbeat 最核心的两个部分是**心跳监测**和**资源接管**。**心跳监测**使设备之间相互发送报文来告诉对方自己当前的状态，如果在指定的时间内未收到对方发送的报文，那么就认为对方失效，这时需启动**资源接管**模块来接管运行在对方主机上的资源或者服务。

>  Heartbeat 最常用的场景是双机热备。

### DRBD
DRBD （Distributed Replicated Block Device）是一种基于软件的，无共享，复制的存储解决方案，在服务器之间对块设备（硬盘，分区，逻辑卷等）进行镜像。DRBD 负责接收数据，把数据写到本地磁盘，然后通过网络将同样的数据发送给另一个主机，另一个主机再将数据存到自己的磁盘中。

工作原理：每个设备都有一个状态，可能是**主状态**或**从状态**。在主节点上，应用程序应能运行和访问 DRBD 设备（/dev/drbd*），且每次写入都会发往本地磁盘设备和从节点设备中。从节点只能简单地把数据写入它的磁盘设备上。 读取数据通常在本地进行。 如果主节点发生故障，心跳（heartbeat 或 corosync）将会把从节点转换到主状态，并启动其上的应用程序。如果发生故障的节点恢复工作，它就会成为新的从节点，而且必须使自己的内容与主节点的内容保持同步。

# Heartbeat 部署方案（CentOS）

主从节点都使用`yum install heartbeat*`命令安装 Heartbeat（须确保已安装 epel 扩展软件包源）。

## 配置
Heartbeat 主要的配置文件有 3 个，分别是 authkeys，ha.cf 和 haresources。其中 ha.cf 是主配置文件，haresource 用来配置要让 Heartbeat 托管的服务，authkey 是用来指定 Heartbeat 的认证方式。

> 在 Heartbeat 安装后，默认并没有这三个文件，可以直接从解压的源码目录中找到。

这里以 master/slave 两节点为例，示例的配置文件为 master 的。

### 认证文件（/etc/ha.d/authkeys）

该文件为 Heartbeat 的认证文件，该文件主要是用于集群中两个节点的认证，采用的算法和密钥（如果有的话）在集群中节点上必须相同。目前提供了 3 种算法：crc/md5/sha1。其中 crc 不能够提供认证，它只能够用于校验数据包是否损坏，而 sha1/md5 需要一个密钥来进行认证。

```
auth 2
#1 crc
2 sha1 somewords
#3 md5 somewords
```

以上示例中使用的是 sha1 算法，如果要换用其他算法只需要修改 auth 指令后面的数字，然后取消相应行的注释即可。

> 注意：该文件的属性必须为600，否则 Heartbeat 启动将失败。且两个节点的 authkeys 文件内容及权限相同。

### 主配置文件（/etc/ha.d/ha.cf）

该文件是 Heartbeat 的主配置文件。

```
keepalive 2
warntime 5
deadtime 30
initdead 120
udpport 6942
bcast eth0
# mcast eth0 225.0.0.1 694 1 0
ucast eth1 {{ slave的IP地址 }}
auto_failback off
watchdog /dev/watchdog
node host41 host42
# ping 172.16.12.1 ping_group group1 172.16.12.1
respawn hacluster /usr/lib64/heartbeat/ipfail
respawn hacluster /usr/lib64/heartbeat/dopd
apiauth dopd gid=haclient uid=hacluster
use_logd yes
```

- keepalive：发送心跳报文的间隔。默认单位为秒，也可以使用 500ms 来代理 500 毫秒，等同于 0.5。
- warntime：认为对方可能宕掉的间隔时间。
- deadtime：认为对方宕掉的间隔时间，超过这个时间，则认为对方已经宕掉。
- initdead：等待对方启动的最大时间。
- udpport：heartbeat 广播/单播通讯使用的 udp 端口。
- bcast：心跳所使用的网络接口。
- ucast：单播通讯，对方网络接口及IP地址。
- mcast：组播通讯，参数如右：通讯所用的接口 绑定的组播IP（224.0.0.0-239.255.255.255）通讯端口 ttl 是否允许环回。
- auto_failback：表示当主节点（即提供资源/服务的节点）正常之后是否将资源/服务切换回来。
- watchdog：看门狗定时器，如果节点一分钟内没有心跳，则重启节点。
- node：heartbeat 集群中的节点信息（节点的主机名: uname -n）。
- ping/ping_group：用于建立伪集群成员，作用是监测物理链路，如果该节点与伪集群成员不相通，那么该节点无权接管资源/服务。

另一从节点（slave）需要将 ha.cf 文件中 ucast 的 IP 地址改为 master 的 IP 地址。

### 资源文件（/etc/ha.d/haresources）



# 参考文档

[Linux-HA开源软件Heartbeat（配置篇）](http://ixdba.blog.51cto.com/2895551/548625)
[heartbeat配置相关](https://github.com/chenzhiwei/linux/tree/master/heartbeat)